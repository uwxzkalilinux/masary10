<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Track Information Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Roboto', sans-serif; background: radial-gradient(circle at 50% 50%, #0b0c1c, #1a1a2e); color: #fff; overflow-x: hidden; }
    #galaxy-container { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; overflow:hidden; }
    .planet { position:absolute; border-radius:50%; background: rgba(255,255,255,0.7); width:4px; height:4px; animation: move 20s linear infinite; }
    @keyframes move { 0% {transform: translateY(-100px);} 100% {transform: translateY(120vh);} }

    /* Radar */
    #radar {
      position: absolute; top:20px; right:20px; width:120px; height:120px; border:3px solid #0f0;
      border-radius:50%; z-index:5; overflow:hidden; transform: rotate(0deg);
    }
    #radar-sweep {
      position:absolute; width:100%; height:100%; background: rgba(0,255,0,0.2);
      clip-path: polygon(50% 50%, 0% 0%, 100% 0%); transform-origin:50% 50%;
    }
    .rotate { animation: radar-spin 2s linear infinite; }
    @keyframes radar-spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

    .column { position: relative; z-index: 10; }
    h1,h2,p,strong { z-index:10; position:relative; }
  </style>
</head>
<body>
  <div id="galaxy-container"></div>

  <!-- Radar -->
  <div id="radar">
    <div id="radar-sweep"></div>
  </div>

  <div class="w-full max-w-6xl mx-auto py-10 px-4 flex flex-col items-center">
    <!-- Header -->
    <div class="flex justify-between items-center w-full mb-6">
      <h1 class="text-4xl font-extrabold text-green-400 drop-shadow-lg">ðŸšš Track Information Dashboard</h1>
      <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-xl shadow-lg transition transform hover:scale-105">Logout</button>
    </div>

    <!-- Search -->
    <div class="w-full bg-gray-900 bg-opacity-70 p-8 rounded-3xl shadow-2xl backdrop-blur-md mb-6">
      <div class="flex gap-4 mb-6">
        <input id="uniqueId" class="flex-1 border-2 border-green-400 rounded-xl px-5 py-3 text-lg focus:outline-none focus:ring-4 focus:ring-green-500 shadow-inner bg-black text-white" placeholder="Enter unique number" />
      </div>
      <button onclick="fetchData()" class="w-full bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white py-3 rounded-2xl text-lg font-semibold shadow-lg transition transform hover:scale-105">ðŸš€ Fetch Data</button>
    </div>

    <!-- Stats -->
    <div id="stats" class="text-center mb-6 text-lg font-bold text-white"></div>

    <!-- Results Columns -->
    <div class="grid md:grid-cols-2 gap-6 w-full">
      <div id="withoutSonarColumn" class="column bg-gray-800 bg-opacity-50 rounded-3xl p-6 shadow-xl">
        <h2 class="text-2xl font-extrabold text-red-500 mb-4">ðŸš« Without Sonar</h2>
      </div>
      <div id="withSonarColumn" class="column bg-gray-800 bg-opacity-50 rounded-3xl p-6 shadow-xl">
        <h2 class="text-2xl font-extrabold text-green-400 mb-4">âœ… With Sonar</h2>
      </div>
    </div>
  </div>

  <script>
    // Galaxy animation
    const galaxyContainer = document.getElementById("galaxy-container");
    for(let i=0;i<150;i++){
      const planet = document.createElement('div');
      planet.className = 'planet';
      planet.style.width = (2+Math.random()*4)+'px';
      planet.style.height = planet.style.width;
      planet.style.left = Math.random()*100+'%';
      planet.style.top = Math.random()*100+'%';
      planet.style.animationDuration = (10+Math.random()*20)+'s';
      planet.style.background = `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},0.7)`;
      galaxyContainer.appendChild(planet);
    }

    // Login check
    document.addEventListener('DOMContentLoaded', () => {
      if(localStorage.getItem('isLoggedIn') !== 'true') window.location.href = 'login.html';
    });

    function logout() {
      localStorage.removeItem('isLoggedIn');
      window.location.href = 'login.html';
    }

    async function fetchData() {
      const uniqueId = document.getElementById("uniqueId").value.trim();
      const stats = document.getElementById("stats");
      const withSonarCol = document.getElementById("withSonarColumn");
      const withoutSonarCol = document.getElementById("withoutSonarColumn");
      const radarSweep = document.getElementById("radar-sweep");

      // Start radar rotation
      radarSweep.classList.add("rotate");

      // Clear old results
      withSonarCol.innerHTML = '<h2 class="text-2xl font-extrabold text-green-400 mb-4">âœ… With Sonar</h2>';
      withoutSonarCol.innerHTML = '<h2 class="text-2xl font-extrabold text-red-500 mb-4">ðŸš« Without Sonar</h2>';
      stats.textContent = '';

      if(!uniqueId){ stats.textContent = "Please enter a unique number."; radarSweep.classList.remove("rotate"); return; }

      try {
        const response = await fetch(`/api/proxy?unique=${encodeURIComponent(uniqueId)}`);
        if(!response.ok) throw new Error(`Failed: ${response.status}`);
        const data = await response.json();
        const trips = data.trips || [];

        if(trips.length===0){ stats.textContent = "ðŸš« No data found."; radarSweep.classList.remove("rotate"); return; }

        let withSonar=0, withoutSonar=0;

        trips.forEach(trip=>{
          const hasSonar = trip.sonarData?.manifests?.length > 0;
          const manifest = trip.sonarData?.manifests?.[0];
          let sonarDate = manifest?.sonarPictureDayTime ? new Date(manifest.sonarPictureDayTime).toLocaleString() : "N/A";

          const card = document.createElement('div');
          card.className = 'bg-gray-900 bg-opacity-70 p-4 rounded-lg mb-3 text-white relative z-10 font-bold text-sm';
          card.innerHTML = `
            <p><strong>Driver:</strong> ${trip.driver_name || 'N/A'}</p>
            <p><strong>Container:</strong> ${trip.container_number || 'N/A'}</p>
            <p><strong>Agent:</strong> ${trip.transportation_agent || 'N/A'}</p>
            <p><strong>Berth:</strong> ${trip.berth || 'N/A'}</p>
            <p><strong>Sonar Date:</strong> ${sonarDate}</p>
          `;
          if(hasSonar){
            withSonarCol.appendChild(card);
            withSonar++;
          } else {
            withoutSonarCol.appendChild(card);
            withoutSonar++;
          }
        });

        stats.textContent = `ðŸ“Š Total: ${trips.length} â€” âœ… ${withSonar} | ðŸš« ${withoutSonar}`;
      } catch(error){
        stats.textContent = "âš ï¸ Error: " + error.message;
      } finally{
        // Stop radar after 2 seconds to simulate search
        setTimeout(()=> radarSweep.classList.remove("rotate"), 2000);
      }
    }
  </script>
</body>
</html>
