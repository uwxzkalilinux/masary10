<body>
  <!-- ✅ الصورة تبقى بمكانها، بس تتغير حسب السونار -->
  <img id="statusImage" src="/img1.jpg" alt="شعار الموقع" width="150" />

  <h1>استعلام عن معلومات مساري علي ناصر</h1>
  <input type="text" id="uniqueId" placeholder="ادخل الرقم الموحد" />
  <button onclick="fetchData()">جلب المعلومات</button>
  <div class="stats" id="stats"></div>
  <div class="columns">
    <div class="column" id="withoutSonarColumn">
      <h2>🚫 بدون سونار</h2>
    </div>
    <div class="column" id="withSonarColumn">
      <h2>✅ بيها سونار</h2>
    </div>
  </div>

  <script>
    async function fetchData() {
      const id = document.getElementById("uniqueId").value;
      const stats = document.getElementById("stats");
      const withSonarCol = document.getElementById("withSonarColumn");
      const withoutSonarCol = document.getElementById("withoutSonarColumn");
      const statusImage = document.getElementById("statusImage"); // ✅ نربط الصورة

      withSonarCol.innerHTML = "<h2>✅ بيها سونار</h2>";
      withoutSonarCol.innerHTML = "<h2>🚫 بدون سونار</h2>";
      stats.innerHTML = "جارٍ التحميل...";
      statusImage.src = "/img1.jpg"; // ترجع للوضع الابتدائي بشكل مؤقت

      try {
        const res = await fetch("/api/proxy?unique=" + id);
        const data = await res.json();

        if (data.trips && data.trips.length > 0) {
          let withSonarCount = 0;
          let withoutSonarCount = 0;

          data.trips.forEach(trip => {
            const hasSonar = trip.sonarData?.manifests?.length > 0;
            const infoHTML = `
              <p><strong>رقم السيارة:</strong> ${trip.truck_number}</p>
              <p><strong>رقم السائق:</strong> ${trip.driver}</p>
              <p><strong>رقم الحاوية:</strong> ${trip.container_number}</p>
              <hr />
            `;
            if (hasSonar) {
              withSonarCol.innerHTML += infoHTML;
              withSonarCount++;
            } else {
              withoutSonarCol.innerHTML += infoHTML;
              withoutSonarCount++;
            }
          });

          // ✅ تغيير الصورة حسب النتائج
          if (withSonarCount > 0) {
            statusImage.src = "/img1.jpg"; // بيها سونار
          } else {
            statusImage.src = "/img2.jpg"; // ما بيها سونار
          }

          stats.innerHTML = `عدد السيارات التي بيها سونار: ${withSonarCount} | عدد السيارات التي لا تحتوي على سونار: ${withoutSonarCount}`;
        } else {
          stats.innerHTML = "لا توجد معلومات متاحة لهذا الرقم.";
        }
      } catch (error) {
        stats.innerHTML = "حدث خطأ أثناء جلب البيانات: " + error;
      }
    }
  </script>
</body>
